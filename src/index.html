<html>
    <head>
        <title>Cfn Graph</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.3/cytoscape.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
        <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.6.5/cytoscape-cose-bilkent.js"></script>
        <script src="https://cdn.rawgit.com/dhotson/springy/2.7.1/springy.js"></script>
        <!--<script src="js/graph.min.js"></script>-->
        <script src="js/cytoscape-springy.js"></script>

        <script src="js/unique1.js"></script>
        <script src="js/set_cytoscape.js"></script>
        <script src="js/cfn-parser.js"></script>
        <script src="js/set_analysis.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
<style>
    #cy {
        width: 100%;
        height: 90% ;
        display: block;
    }
    #input_cfn {
        height:50%;
        width:100%;
    }

    #header_row {
        border-bottom:5px black solid;
        padding:5px;
        margin-bottom:20px;

    }
    #header_row #header_text {
        font-size: 24pt;
    }

    .modal-dialog {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        max-width:100%;
    }

    .modal-content {
        height: auto;
        min-height: 100%;
        border-radius: 0;
    }
</style>
        <script>
            window.onload=function() {
              handle_json_change();
            };

            function node_click(evt) {
                console.log(evt.target.data());
                var type = evt.target.data().type;
                if(type === "resource") {
                    $("#nodeTitle").html(evt.target.data().id + " (Resource)");
                    $("#nodeJson").html(prettyPrintJson(evt.target.data().json));

                } else if (type === "parameter") {
                    $("#nodeTitle").html(evt.target.data().id + " (Parameter)");
                    $("#nodeJson").html(prettyPrintJson(evt.target.data().json));
                    $("#nodeUpstream").html("N/A");
                }
                $("#nodeModal").modal("show");
            }


            function prettyPrintJson(json) {
                return JSON.stringify(JSON.parse(json), null, 2)
            }

            function get_edges(source, targets, type) {

                // List Targets
                var targetStrings = [];
                for(var i = 0; i < targets.length; i++) {
                    targetStrings.push(targets[i]);
                }


                // Dedup Targets
                targetStrings = targetStrings.unique1();

                // Create edges
                var edges = [];
                for(var k = 0; k < targetStrings.length; k++) {
                    var edge = { // edge ab
                        data: {
                            id: source + ">" + targetStrings[k],
                            source: source,
                            target: targetStrings[k],
                            type: type
                        }
                    };
                    edges.push(edge);
                }

                return {
                    edges: edges,
                    targets: targets
                }
            }



            function handle_json_change(sender) {
                var json = $("#input_cfn").val();
                var graph_data = parse_cfn_json(json);
                console.log(graph_data);
                set_analysis(graph_data.graphjs);
                set_cytoscape(graph_data.cytoscape.nodes, graph_data.cytoscape.edges, node_click);
                return false;
            }

            function not_undefined(i) {
                return !(i===undefined);
            }
        </script>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12" id="header_row">
                    <span id="header_text">Cfn Graph</span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="container-fluid">
                        <div class="row">
                            <span class="modal-header">Template (JSON)</span>
                            <textarea id="input_cfn" class="form-control" oninput="handle_json_change();">
{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "AWS CloudFormation Sample Template DynamoDB_Secondary_Indexes: Create a DynamoDB table with local and global secondary indexes. **WARNING** This template creates an Amazon DynamoDB table. You will be billed for the AWS resources used if you create a stack from this template.",

  "Parameters": {
    "ReadCapacityUnits": {
      "Description": "Provisioned read throughput",
      "Type": "Number",
      "Default": "5",
      "MinValue": "5",
      "MaxValue": "10000",
      "ConstraintDescription": "must be between 5 and 10000"
    },

    "WriteCapacityUnits": {
      "Description": "Provisioned write throughput",
      "Type": "Number",
      "Default": "10",
      "MinValue": "5",
      "MaxValue": "10000",
      "ConstraintDescription": "must be between 5 and 10000"
    }
  },

  "Resources": {
    "TableOfBooks": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          { "AttributeName": "Title", "AttributeType": "S" },
          { "AttributeName": "Category", "AttributeType": "S" },
          { "AttributeName": "Language", "AttributeType": "S" }
        ],
        "KeySchema": [
          { "AttributeName": "Category", "KeyType": "HASH" },
          { "AttributeName": "Title", "KeyType": "RANGE" }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": { "Ref": "ReadCapacityUnits" },
          "WriteCapacityUnits": { "Ref": "WriteCapacityUnits" }
        },
        "LocalSecondaryIndexes": [ {
          "IndexName": "LanguageIndex",
          "KeySchema": [
            { "AttributeName": "Category", "KeyType": "HASH" },
            { "AttributeName": "Language", "KeyType": "RANGE" }
          ],
          "Projection": {
            "ProjectionType": "KEYS_ONLY"
          }
        } ],
        "GlobalSecondaryIndexes": [ {
          "IndexName": "TitleIndex",
          "KeySchema": [
            { "AttributeName": "Title", "KeyType": "HASH" }
          ],
          "Projection": {
            "ProjectionType": "KEYS_ONLY"
          },
          "ProvisionedThroughput": {
            "ReadCapacityUnits": { "Ref": "ReadCapacityUnits" },
            "WriteCapacityUnits": { "Ref": "WriteCapacityUnits" }
          }
        } ]
      }
    }
  },

   "Outputs" : {
     "TableName" : {
       "Value" : {"Ref" : "TableOfBooks"},
       "Description" : "Name of the newly created DynamoDB table"
     }
   }
}
</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <span class="modal-header">Analysis</span>
                                <div id="analysis">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-2 bold">Nodes:</div>
                                            <div class="col-md-10"><span id="graphNodeCount"></span></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">Edges:</div>
                                            <div class="col-md-10"><span id="graphEdgeCount"></span></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">Cycles:</div>
                                            <div class="col-md-10"><span id="graphCycles"></span></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">Broken Edges:</div>
                                            <div class="col-md-10"><span id="graphBrokenEdges"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="col-md-8">
                    <span class="modal-header">Graph</span>
                    <div id="cy"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                   Samples:
                    <a href="https://raw.githubusercontent.com/tableau/server-install-script-samples/master/CloudFormation/public-sample-ssl-cluster.cfn" target="_blank">Tableau Cluster</a>
                </div>
            </div>
        </div>

        <div id="nodeModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">

                        <h4 id="nodeTitle" class="modal-title">Modal Header</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div id="nodeBody" class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-6">
                                    <span class="modal-header">Resource JSON</span>
                                    <pre id="nodeJson"></pre>

                                </div>
                                <div class="col-md-6">
                                    <span class="modal-header">Upstream Dependencies</span>
                                    <div id="nodeUpstream"></div>
                                    <span class="modal-header">Downstream Dependencies</span>
                                    <div id="nodeDownstream"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
    </body>
</html>