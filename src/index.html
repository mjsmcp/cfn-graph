<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.3/cytoscape.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
<style>
    #cy {
        width: 100%;
        height: 100%;
        display: block;
    }
    #input_cfn {
        height:100%;
        width:100%;

    }
</style>
        <script>
            function set_cytoscape(nodes, edges) {
                var cy = cytoscape({

                    container: document.getElementById('cy'), // container to render in

                    elements: nodes.concat(edges),

                    style: [ // the stylesheet for the graph
                        {
                            selector: 'node',
                            style: {
                                'background-color': '#666',
                                'label': 'data(id)'
                            }
                        },

                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle'
                            }
                        }
                    ],

                    layout: {
                        name: 'cose',
                        avoidOverlap: true,
                        nodeDimensionsIncludeLabels: true
                    }
                });
            }

            // https://stackoverflow.com/questions/722668/traverse-all-the-nodes-of-a-json-object-tree-with-javascript
            //called with every property and its value
            function get_ref(key,value) {
                var refs = [];
                if(key === "Ref") {
                    refs.push({k: key, v:value});
                }
                return refs;
            }

            // incomplete
            function get_fnsub(key,value) {
                var subs = [];
                if(key === "Fn::Sub") {
                    var rx3 = /\${([^}]+)}/
                    var matches = value.match(rx3);

                    //selects the () group values
                    var validMatches = matches.filter(function(match) {
                        return !rx3.test(match);
                    });

                    for(var vm in validMatches) {
                        subs.push(vm);
                    }
                    console.log(value + "| " + matches);
                }

                return subs;
            }

            function print(key,value) {
                console.log(key + " : " + value);
            }
            function traverse(o,func) {
                var items = [];
                for (var i in o) {
                    items = items.concat(func.apply(this,[i,o[i]]));
                    if (o[i] !== null && typeof(o[i])==="object") {
                        //going one step down in the object tree!!
                        items = items.concat(traverse(o[i],func));
                    }
                }

                return items;
            }


            function handle_json_change(sender) {
                try {
                    var jsonObject = JSON.parse($("#input_cfn").val());
                    // Get relevant top-level items
                    var parameters = jsonObject.Parameters;
                    var resources = jsonObject.Resources;

                    // Set lists
                    var nodes = [];
                    var edges = [];



                    // Process parameters
                    console.log("Parameters: " + parameters.length);
                    for(param in parameters) {
                        nodes.push({
                            data: { id: param, type: 'parameter' }
                        });
                    }


                    // Process resources
                    console.log("Resources: " + resources.length);
                    for(var keyName in resources) {
                        var edges = [];
                        var res = resources[keyName];
                        nodes.push({
                            data: { id: keyName, type: 'resource' }
                        });

                        // Get Refs
                        var resRef = traverse(res, get_ref);
                        for(var ref in resRef) {
                            var refTarget = resRef[ref].v;

                            var edge = { // edge ab
                                data: { id: keyName + ">" + refTarget, source: keyName, target: refTarget, type: 'ref' }
                            };
                            edges.push(edge);
                        }

                        // Get FnSubs
                    }


                    console.log(nodes);
                    console.log(edges);

                    set_cytoscape(nodes, edges);
                } catch(err) {
                    console.error(err);
                    return false;
                }
            }
        </script>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12"><h2>CfnGraph</h2></div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <span class="col-header">Template (JSON)</span>
                    <textarea id="input_cfn" class="form-control" oninput="handle_json_change();"></textarea>
                </div>

                <div class="col-md-8">
                    <span class="col-header">Graph</span>
                    <div id="cy"></div>
                </div>
            </div>
        </div>
    </body>
</html>